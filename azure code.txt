trigger:
  branches:
    include:
      - develop

pool:
  vmImage: 'windows-latest'

variables:
  group: powerbi  # Ensure this contains clientid, clientsecret, tenantid
  SOURCE_WORKSPACE_ID: "c017440f-4a5b-46bd-a2c0-93ee3f04ab4d"  # Dev workspace ID
  TARGET_WORKSPACE_ID: "a4628c7b-adda-4285-8c1f-758b19162d0b"  # UAT workspace ID
  MODULE_LIST: |
    - MicrosoftPowerBIMgmt
    - Invoke-DQVTesting
    - Invoke-SemanticModelRefresh

steps:
# Step 1: Checkout Repository
- checkout: self
  displayName: 'Checkout Repository'

# Step 2: Install Dependencies Dynamically
- task: PowerShell@2
  displayName: 'Install Required Modules'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      Write-Host "Installing dependencies dynamically..."
      foreach ($module in ${{ variables.MODULE_LIST }}) {
        if (-not (Get-Module -ListAvailable -Name $module)) {
          Install-Module -Name $module -Scope CurrentUser -Force
        }
      }

# Step 3: Authenticate with Power BI Service
- task: PowerShell@2
  displayName: 'Authenticate Power BI Service'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      Connect-PowerBIServiceAccount -ServicePrincipal -Credential (New-Object System.Management.Automation.PSCredential($env:CLIENT_ID, (ConvertTo-SecureString $env:CLIENT_SECRET -AsPlainText -Force))) -TenantId $env:TENANT_ID

# Step 4: Detect Changes in Commit
- task: PowerShell@2
  displayName: 'Detect Changed Files'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      Write-Host "Detecting changed files..."
      $changedFiles = git diff --name-only HEAD~1..HEAD
      Write-Host "Changed files: $changedFiles"

# Step 5: Validate Semantic Models and Reports
- task: PowerShell@2
  displayName: 'Validate Semantic Models and Reports'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      Write-Host "Validating Semantic Models and Reports..."
      foreach ($file in $changedFiles) {
        if ($file -match "semanticmodel") {
          Write-Host "Validating semantic model: $file"
          # Validation logic for semantic models
          $model = Import-SemanticModel -FilePath $file
          if (-not $model.IsValid) {
            throw "Semantic model validation failed for $file"
          }
        }
        if ($file -match "report") {
          Write-Host "Validating report: $file"
          # Validation logic for reports
          $report = Get-PowerBIReport -FilePath $file
          if (-not $report.IsValid) {
            throw "Report validation failed for $file"
          }
        }
      }

# Step 6: Promote Files to UAT
- task: PowerShell@2
  displayName: 'Promote Files to UAT'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      Write-Host "Promoting files to UAT..."
      foreach ($file in $changedFiles) {
        if ($file -match "semanticmodel") {
          Write-Host "Promoting semantic model $file to UAT"
          Publish-SemanticModel -FilePath $file -WorkspaceId ${{ variables.TARGET_WORKSPACE_ID }}
        }
        if ($file -match "report") {
          Write-Host "Promoting report $file to UAT"
          Publish-PowerBIReport -FilePath $file -WorkspaceId ${{ variables.TARGET_WORKSPACE_ID }}
        }
      }

# Step 7: Log Results
- task: PowerShell@2
  displayName: 'Log Results'
  inputs:
    pwsh: true
    targetType: inline
    script: |
      Write-Host "Logging results..."
      # Log timestamp
      Get-Date | Out-File -FilePath $(Pipeline.Workspace)/log.txt -Append
      # Log changes and promotions
      foreach ($file in $changedFiles) {
        $logEntry = "Promoted file: $file"
        $logEntry | Out-File -FilePath $(Pipeline.Workspace)/log.txt -Append
      }
      Write-Host "Logs stored in: $(Pipeline.Workspace)/log.txt"

